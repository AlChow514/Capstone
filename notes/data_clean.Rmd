---
title: "Data Cleaning"
author: "Albert Chow"
date: "11/14/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r message=FALSE, warning=FALSE}
library(tidyverse)
```

<h3>
Load Data
</h3>
```{r}
ast_data <- read_csv("../Data/Linelist SENTRY site_136.csv", na = c(""))

```
<hr>
<br></br>
<h3>
Filtering EC data
</h3>
```{r}
# Selects for EC while dropping all na columns
ast_ecoli <- ast_data %>% 
  filter(`Organism Code` == "EC") %>% 
  select(which(colSums(!is.na(.)) > 0)) %>%  
  #select_if(colSums(!is.na(.)) > 0) %>% 
  select(`Collection Number`, `Study Year`, `Organism Code`, `Infection Type`, c(18:56))

# Separate UTI data
ast_ec_uti <- ast_ecoli %>% 
  filter(`Infection Type` == "urinary tract infection")

ast_ecoli <- ast_ecoli %>% 
  filter(`Infection Type` != "urinary tract infection")

# Save working DF
# save(ast_ecoli, file = "../Data/ast_ecoli.RData")

# make csv of drugs that was tested
drg_tested <- ast_ecoli %>% 
  select_if(colSums(!is.na(.)) > 0) %>% 
  select(c(5:length(.)))

drg_tested_names <- as.data.frame(names(drg_tested))
# write_csv(drg_tested_names, "../Data/ec_bp.csv")
```
<hr>
<br></br>
<h3>
Casey's code to tabulate data
</h3>
```{r}
# function to summarize percent of isolates with missing MIC
pct_missing <- function (x){
  round(sum(is.na(x)) / length(x), 2)
}

#tabulate the percent of missing data for each anti-microbials by study year
ec_tab <- ast_ecoli %>% 
  select(`Study Year`, c(5:length(.))) %>% 
  group_by(`Study Year`) %>%  
  summarise(across(1:39, pct_missing))

# drugs questionable at least tested in 5 years
drugs <- ec_tab %>% 
  select(-`Study Year`) %>% 
  summarise(across(.cols = everything(), sum)) %>% 
  select(which(. <= 0))

am_included <- names(drugs)

# Table of AST data with drugs that was tested for more than 5 years
ast_ecoli_cleaned <- ast_ecoli %>% 
  select(all_of(am_included))
### save(ast_ecoli_cleaned, file = "../Data/ast_ecoli_cleaned.RData")

# vector name of drugs tested for filtering if needed
ast_ec_omit <- ast_ecoli %>% 
  select(-all_of(am_included))

drugs_tested <- tibble(am_included)
```
<hr>
<br></br>
<h3>
Cleaning Bp data
</h3>
```{r}
bp_ec_eucast <- read_csv("../Data/ec_bp_eucast.csv")
bp_ec_clsi <- read_csv("../Data/ec_bp_clsi.csv")

#Drop am without s and r
bp_ec_eucast <- bp_ec_eucast %>% 
  filter(!is.na(.$`S <=`) & !is.na(.$`R >`)) %>% 
  mutate('NSbp' = as.numeric(`S <=`))

bp_ec_clsi <- bp_ec_clsi %>% 
  filter(!is.na(.$`S <=`) & !is.na(.$`R >=`)) %>% 
  mutate('NSbp' = as.numeric(`S <=`))
```
<hr>
<br></br>
<h3>
Data Cleaning 
</h3>
```{r}
names(bp_ec_eucast)[1] <- "Antimicrobial" #CC, mic interp function references a column "Antimicrobial" with capital "A"
# numerical index for mic to interpretation function
eucast_am_bp_ind <- match(bp_ec_eucast$Antimicrobial, names(ast_ecoli_cleaned))
eucast_am_bp_ind <- eucast_am_bp_ind[!is.na(eucast_am_bp_ind)]

clsi_am_bp_ind <- match(bp_ec_clsi$antimicrobial, names(ast_ecoli_cleaned))
clsi_am_bp_ind <- clsi_am_bp_ind[!is.na(clsi_am_bp_ind)]

source("../scripts/dataclean_fun.R", local = FALSE, echo = TRUE, spaced = TRUE)

ec_interp_eucast <- mic_interp(ast_ecoli_cleaned, eucast_am_bp_ind, bp_ec_eucast)


ec_interp_eucast <- MIC_to_interpretation(ast_ecoli_cleaned, eucast_am_bp_ind, bp_ec_eucast) #CC use this one.

```

<hr>
<br></br>
<h3>
Some descriptive stats
</h3>
```{r}
 # Counts of isolates by study year
ast_ecoli_cleaned %>% 
  group_by(
    `Infection Type`,
    `Study Year`
  ) %>% 
  summarise(N = n())

# Count of isolates by infection type
ast_ecoli_cleaned %>% 
  group_by(`Infection Type`) %>% 
  summarise(N = n())
```







Sandbox to make functions
```{r}



```
Functions
```{r}



```

