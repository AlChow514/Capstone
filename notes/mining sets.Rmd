---
title: "mining sets"
author: "Albert Chow"
date: "3/5/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(arules)
```

Mining sets
```{r}
# find indexes of antimicrobial column in df, ecv and clsi data is the same
am_col <- eu_mdr_df %>% 
  select(1:15) 
am_col <- match(names(am_col)[sapply(am_col, is.logical)], names(am_col))


# All infection types transactions
eu_all_types <- as(eu_all_db, "transactions")

# eu_all_types
# 1. Minimum support
min_sup <- 1 / length(eu_all_types)
sets <- apriori(eu_all_types, parameter = list(support = min_sup,
                                               maxlen = length(am_col),
                                               minlen = 2,
                                               target = "frequent itemsets"))
## 2. Quality measures
itemset_list <- LIST(items(sets), decode = FALSE)
CrossSupRatio <- interestMeasure(sets, "crossSupportRatio", eu_all_types, reuse = TRUE)
lift <- interestMeasure(sets, "lift", eu_all_types, reuse = TRUE)

```

Iteration for all sets
```{r}
# find indexes of antimicrobial column in df, ecv and clsi data is the same
am_col <- eu_mdr_df %>% 
  select(1:15) 
am_col <- match(names(am_col)[sapply(am_col, is.logical)], names(am_col))

# eu sets
eu_db_sets <- c("eu_all_db", "eu_bld_db", "eu_inab_db", "eu_pneu_db", "eu_skin_db")

# create eu transaction databases
for (i in seq_along(eu_db_sets)) {
  x <- as(get(eu_db_sets[i]), "transactions")
  label <- paste(as.character(paste(eu_db_sets[i], "_trans", sep = "")))
  assign(label, x)
  rm(x)
  rm(label)
}

# Mine sets
eu_trans_names <- c("eu_all_db_trans", "eu_bld_db_trans", "eu_inab_db_trans", "eu_pneu_db_trans", "eu_skin_db_trans")
eu_set_names <- c("eu_all_set", "eu_bld_set", "eu_bld_set", "eu_inab_set", "eu_pneu_set", "eu_skin_set")
for (i in seq_along(eu_trans_names)) {
  data <- get(eu_trans_names[i])
  # minimum support
  min_sup <- 1 / length(data)
  sets <- apriori(data,
                  parameter = list(support = min_sup,
                                   maxlen = length(am_col),
                                   minlen = 2,
                                   target = "frequent itemsets"))
  # Quality Measures
  CrossSupRatio <- interestMeasure(sets,
                                   "crossSupportRatio",
                                   data,
                                   reuse = TRUE)
  lift <- interestMeasure(sets,
                          "lift",
                          data,
                          reuse = TRUE)
  # save
  assign(eu_set_names[i], sets)
  rm(data, min_sup, sets, CrossSupRatio, lift)
}
```


